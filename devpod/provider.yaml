name: gloo-platform
version: 0.0.1
description: |-
  DevPod on Kubernetes
options:
  NAMESPACE:
    required: true
    description: The namespace to use
    # command: |-
    #   NAMESPACE=$(kubectl config view --minify -o jsonpath='{..namespace}' 2>/dev/null || true)
    #   if [ -z "${NAMESPACE}" ]; then
    #     NAMESPACE=default
    #   fi
    #   echo $NAMESPACE
  FEATURE_ID:
    required: true
    description: The feature id to develop
  SERVICE_NAME:
    required: true
    description: The name of the service for to use to develop
  SERVICE_PORT:
    required: true
    description: The port number of the service
  SERVICE_TARGET_PORT:
    required: true
    description: The port number of the servie target port
agent:
  path: /tmp/devpod
exec:
  command: |-
    kubectl exec -n "${NAMESPACE}" -c devpod-container -i devpod-${MACHINE_ID} -- sh -c "${COMMAND}"
  create: |-
    kubectl create -n "${NAMESPACE}" -f - << EOF
    apiVersion: v1
    kind: Service
    metadata:
      name: ${SERVICE_NAME}
      namespace: ${NAMESPACE}
      labels:
        app: ${SERVICE_NAME}
        featureid: "${FEATURE_ID}"
    spec:
      selector:
        app: ${SERVICE_NAME}
        featureid: "${FEATURE_ID}"
      ports:
      - name: http
        protocol: TCP
        port: ${SERVICE_PORT}
        targetPort: ${SERVICE_TARGET_PORT}
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: devpod-${MACHINE_ID}
      namespace: ${NAMESPACE}
      labels:
        app: ${SERVICE_NAME}
        featureid: "${FEATURE_ID}"
    spec:
      volumes:
        - name: devpod-storage
          emptyDir: {}
      containers:
        - name: devpod-container
          image: mcr.microsoft.com/devcontainers/javascript-node
          volumeMounts:
          - mountPath: /var/lib/docker
            name: devpod-storage
            subPath: var/lib/docker
          - mountPath: /root
            name: devpod-storage
            subPath: root
          securityContext:
            privileged: true
    EOF
  delete: |-
    kubectl delete pod devpod-${MACHINE_ID} -n "${NAMESPACE}" || true